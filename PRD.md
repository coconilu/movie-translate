# 产品需求文档 (PRD) - 电影翻译系统

## 1. 项目概述

### 1.1 产品愿景
开发一个智能电影翻译系统，能够自动识别非中文电影的音频内容，生成字幕，翻译成中文，并通过声音克隆技术为每个角色创建中文配音。

### 1.2 核心功能
- 视频文件导入（支持拖拽和选择）
- 音频提取和语音识别（SRT格式）
- 多语言翻译支持
- 角色识别和音色分析
- 声音克隆和配音生成
- 缓存管理和错误重试机制

## 2. 用户故事

### 2.1 主要用户流程
1. **用户导入文件**
   - 支持拖拽文件到应用界面
   - 支持通过文件浏览器选择视频或音频文件
   - 显示文件基本信息（时长、格式、大小等）

2. **音频处理流程**
   - 智能识别文件类型：视频文件自动提取音频轨道，音频文件直接处理
   - 执行语音识别生成原始字幕
   - 调用翻译API生成中文字幕
   - 识别角色并分析音色特征

3. **角色管理**
   - 展示识别到的角色列表
   - 每个角色显示：性别、音色特征、配音样本
   - 支持角色信息编辑

4. **配音生成**
   - 使用角色音色克隆生成中文配音
   - 合成配音到原视频
   - 支持不同配音质量选择

## 3. 功能需求

### 3.1 文件导入模块
- **视频格式支持**：MP4, AVI, MKV, MOV等常见格式
- **音频格式支持**：MP3, WAV, M4A, FLAC等常见格式
- **导入方式**：拖拽 + 文件选择器
- **文件验证**：检查文件完整性、格式支持
- **智能识别**：自动识别文件类型（视频/音频）
- **预览功能**：显示文件缩略图、时长、文件大小
- **音频文件直接处理**：音频文件跳过音频提取步骤，直接进入语音识别

### 3.8 设置管理模块
- **缓存设置**：显示缓存路径、大小、使用情况
- **路径管理**：点击缓存路径可在资源管理器中打开
- **缓存清理**：支持手动清理缓存文件
- **存储监控**：实时显示磁盘使用情况
- **系统信息**：显示系统版本、硬件信息等

### 3.2 音频处理模块
- **音频提取**：从视频中分离音频轨道（音频文件跳过此步骤）
- **格式转换**：统一音频格式（WAV/MP3）
- **质量检测**：评估音频质量，影响识别准确率
- **智能处理流程**：根据文件类型自动选择处理路径

### 3.3 语音识别模块
#### 模型选择机制：
- **用户手动选择**：用户可自由选择本地模型或在线API服务
- **无智能切换**：系统不会自动切换模型，确保用户控制权
- **配置保存**：用户的选择会被保存，下次使用时自动应用

#### 本地模型选项：
- **SenseVoice**：中文优化，支持情感识别，高准确率

#### 在线API选项：
- **百度语音**：中文优化，支持方言识别

### 3.4 翻译模块
- **DeepSeek R1**：高质量翻译，支持上下文理解
- **GLM-4.5 (智谱)**：中文优化，支持专业术语
- **备选方案**：Google Translate API、百度翻译API

### 3.5 角色识别模块
- **语音分离**：区分不同角色的语音片段
- **音色分析**：提取声音特征（音调、音色、语速等）
- **性别识别**：基于声音特征判断角色性别
- **角色分类**：按出现频率和重要性排序

### 3.6 声音克隆模块
#### 服务选择机制
- **用户手动选择**：用户可自由选择本地模型或云端API服务
- **无智能路由**：系统不会自动切换服务，确保用户控制权
- **配置保存**：用户的选择会被保存，下次使用时自动应用

**F5-TTS本地方案：**
- **模型特点**：零样本声音克隆，无需大量训练数据
- **硬件要求**：NVIDIA GPU 4GB+显存，支持CUDA加速
- **处理速度**：5-10分钟训练，5-10秒生成1分钟音频
- **音质表现**：自然度高，情感表达丰富
- **适用场景**：高质量要求、网络不稳定环境、隐私保护需求

**MiniMax Audio云端方案：**
- **API特点**：企业级声音克隆服务，质量稳定
- **调用限制**：每月1000次免费调用，超出后按次计费
- **处理速度**：1-3分钟训练，3-5秒生成1分钟音频
- **音质表现**：专业级音质，支持多种情感风格
- **适用场景**：批量处理、需要稳定质量的商业项目、硬件配置不足

**音色建模**：为每个角色创建声音模型
**语音合成**：使用角色音色生成中文配音
**质量调整**：支持不同合成质量设置
**试听功能**：预览角色配音效果

### 3.7 缓存管理模块
- **结果缓存**：缓存每个步骤的处理结果
- **断点续传**：支持从失败点继续处理
- **存储优化**：定期清理过期缓存
- **导出功能**：支持导出中间结果
- **缓存可视化**：在设置中显示缓存路径和大小
- **路径管理**：支持点击缓存路径在资源管理器中打开
- **步骤级缓存**：每个处理步骤独立缓存，支持选择性恢复
- **缓存状态管理**：实时显示每个步骤的缓存状态和大小

### 3.8 步骤导航模块
- **步骤列表**：左侧固定显示所有处理步骤
- **状态可视化**：使用图标和颜色显示步骤状态（完成、进行中、暂停、失败等）
- **步骤详情**：点击步骤显示详细信息和操作选项
- **进度显示**：实时显示每个步骤的处理进度和耗时
- **步骤控制**：支持暂停、中断、跳过、重试等操作
- **步骤高亮**：当前执行步骤高亮显示

### 3.9 中断恢复模块
- **灵活中断**：支持保存进度中断和直接中断
- **状态恢复**：从中断点恢复处理，避免重复工作
- **错误恢复**：失败步骤自动重试或手动重试
- **进度保存**：处理进度实时保存，确保数据不丢失
- **中断确认**：中断前显示确认对话框，提供操作选项
- **恢复提示**：启动时检测未完成项目，提示恢复处理

### 3.10 错误恢复机制
**多级错误处理策略：**
1. **自动重试机制**：
   - 网络错误：自动重试3次，间隔递增（1s, 3s, 5s）
   - API超时：切换到备选服务或本地模型
   - 磁盘空间：清理临时文件后重试
   - 内存不足：释放缓存后重试
   - 模型加载失败：重新下载或切换备选模型

2. **故障恢复流程**：
   - **步骤级恢复**：单个步骤失败时，不影响其他已完成步骤
   - **数据完整性检查**：恢复前验证缓存数据完整性
   - **智能回退**：API失败时自动切换到本地备选方案
   - **部分结果保留**：即使失败也保留已处理的部分结果
   - **断点续传**：支持从失败点继续处理

3. **用户干预机制**：
   - **错误诊断**：提供详细的错误信息和解决方案建议
   - **手动重试**：用户可选择特定步骤重试
   - **参数调整**：失败时提示调整相关参数
   - **支持求助**：一键生成错误报告，便于技术支持
   - **降级处理**：在资源不足时提供简化处理选项

4. **系统自愈能力**：
   - **环境检测**：启动时检查系统环境（GPU、内存、磁盘空间）
   - **依赖检查**：验证所需模型和库文件完整性
   - **配置修复**：自动修复损坏的配置文件
   - **日志记录**：详细记录错误信息，便于问题追踪
   - **健康检查**：定期检查各模块运行状态

**错误分类和处理策略：**
- **可恢复错误**（网络超时、临时磁盘空间不足）：自动重试
- **需用户干预错误**（API密钥无效、权限问题）：提示用户处理
- **系统错误**（模型损坏、配置文件丢失）：自动修复或降级
- **致命错误**（系统资源严重不足）：优雅停止并保存进度

**灾难恢复策略：**
- **定期备份**：重要处理结果定期备份到安全位置
- **版本控制**：配置文件和模型版本管理
- **应急模式**：在资源不足时启用简化处理流程
- **数据恢复**：从备份恢复处理进度和结果
- **回滚机制**：支持回滚到上一个稳定状态

**错误监控和报告：**
- **实时监控**：监控系统各模块运行状态
- **错误聚合**：相同错误合并报告，避免重复通知
- **趋势分析**：分析错误发生趋势，预防潜在问题
- **性能指标**：记录错误对系统性能的影响

## 4. 非功能性需求

### 4.1 性能要求
- **处理速度**：1小时视频在45分钟内完成处理（本地模型）
- **内存使用**：峰值内存使用不超过6GB
- **磁盘空间**：预留10GB临时存储空间
- **启动速度**：应用启动时间不超过5秒
- **响应速度**：UI操作响应时间不超过200ms
- **串行处理**：一次只处理一个文件，确保系统稳定性

### 4.2 性能基准测试标准
**处理速度基准：**
- **音频提取**：1小时视频处理时间≤2分钟
- **语音识别**：1小时音频处理时间≤12分钟（SenseVoice本地）
- **翻译处理**：1000字翻译时间≤30秒（DeepSeek R1）
- **角色识别**：1小时音频处理时间≤5分钟
- **声音克隆**：1分钟音频生成时间≤10秒（F5-TTS本地）
- **视频合成**：1小时视频合成时间≤8分钟

**系统资源基准：**
- **CPU使用率**：平均≤70%，峰值≤90%
- **GPU使用率**：平均≤60%，峰值≤85%
- **内存占用**：正常≤4GB，峰值≤6GB
- **磁盘I/O**：写入速度≥50MB/s，读取速度≥100MB/s
- **网络带宽**：在线API调用需要≥1Mbps稳定连接

**质量评估基准：**
- **语音识别准确率**：≥95%（清晰音频）
- **翻译准确率**：≥90%（通用内容）
- **声音克隆相似度**：≥85%（主观评估）
- **音频质量**：MOS评分≥4.0（5分制）
- **同步精度**：音视频同步误差≤100ms

**稳定性基准：**
- **连续运行时间**：≥24小时无故障
- **错误恢复率**：≥95%（可恢复错误）
- **内存泄漏**：连续运行24小时内存增长≤100MB
- **文件处理成功率**：≥98%（支持的格式）
- **并发处理能力**：支持1个文件处理+1个文件排队

**兼容性基准：**
- **视频格式支持**：MP4, AVI, MKV, MOV, WMV, FLV
- **音频格式支持**：MP3, WAV, M4A, FLAC, AAC
- **字幕格式支持**：SRT, ASS, SSA, VTT
- **操作系统**：Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **硬件兼容**：支持Intel/AMD CPU，NVIDIA/AMD GPU

### 4.2 可靠性要求
- **错误处理**：每个步骤都有完善的错误处理机制
- **重试机制**：失败后自动重试，最多3次
- **数据完整性**：确保处理过程中数据不丢失
- **系统稳定性**：7x24小时稳定运行

### 4.3 可用性要求
- **界面友好**：简洁直观的用户界面
- **操作便捷**：拖拽操作，一键处理
- **进度显示**：实时显示处理进度
- **帮助文档**：提供使用指南和故障排除
- **缓存管理**：提供直观的缓存管理界面，支持查看和清理
- **步骤可视化**：左侧步骤列表，清晰显示处理流程和状态
- **操作灵活性**：支持暂停、中断、跳过、重试等操作
- **状态管理**：实时显示每个步骤的状态、进度和缓存情况
- **错误处理**：提供友好的错误提示和恢复机制
- **中断恢复**：支持从中断点恢复，避免重复工作

### 4.4 可扩展性要求
- **模块化设计**：便于添加新的语音识别或翻译服务
- **配置化**：支持不同模型和参数配置
- **插件系统**：支持第三方插件扩展
- **本地API接口**：提供本地REST API供其他应用集成

### 4.5 桌面应用特性
- **本地部署**：无需云服务，完全本地运行
- **拖拽操作**：支持文件拖拽到应用窗口
- **系统托盘**：支持最小化到系统托盘
- **单文件打包**：PyInstaller打包为单个可执行文件
- **自动更新**：支持应用自动检查和下载更新
- **多语言界面**：支持界面语言切换
- **主题切换**：支持明暗主题切换

## 5. 技术选型与架构

### 5.1 整体技术架构
系统采用Python全栈桌面应用架构，包含以下层次：
- **桌面应用层**：CustomTkinter/PySide6构建的用户界面
- **本地服务层**：FastAPI提供的后端服务
- **业务逻辑层**：核心业务处理模块
- **数据存储层**：SQLite本地数据库和文件系统
- **外部服务层**：第三方API和机器学习模型

### 5.2 桌面应用技术栈
| 技术类别 | 选择 | 理由 |
|---------|------|------|
| **UI框架** | CustomTkinter / PySide6 | 现代化桌面UI框架，跨平台支持 |
| **备选方案** | PyQt6, Tkinter | 成熟稳定的桌面应用框架 |
| **图形渲染** | Canvas / QPainter | 高性能图形绘制 |
| **多线程** | threading / asyncio | 支持后台任务处理 |
| **文件拖拽** | tkinterdnd2 / PySide6拖拽 | 原生拖拽支持 |
| **系统托盘** | pystray | 系统托盘图标支持 |
| **打包工具** | PyInstaller / Nuitka | 将Python应用打包为可执行文件 |

### 5.3 本地服务技术栈
| 技术类别 | 选择 | 理由 |
|---------|------|------|
| **框架** | FastAPI | 高性能异步框架，自动生成API文档 |
| **ORM** | SQLAlchemy | 成熟的ORM，支持异步 |
| **数据库** | SQLite | 轻量级本地数据库，无需额外服务 |
| **文件存储** | 本地文件系统 | 简单可靠的文件存储 |
| **任务队列** | ThreadPoolExecutor | 本地任务队列管理 |
| **进程通信** | WebSocket / HTTP | 本地进程间通信 |
| **API文档** | OpenAPI 3.0 | 自动生成API文档 |
| **日志** | Loguru | 简单易用的日志库 |

### 5.4 机器学习技术栈
| 技术类别 | 选择 | 理由 |
|---------|------|------|
| **语音识别** | SenseVoice (本地) / 百度语音 (云端) | SenseVoice中文优化，支持情感识别；百度语音中文优化，支持方言识别 |
| **翻译模型** | DeepSeek R1 (主) / GLM-4.5 (备选) | 高质量翻译，支持上下文 |
| **声音克隆** | F5-TTS (本地) / MiniMax Audio (云端) | 混合方案，平衡质量与成本 |
| **角色识别** | PyAnnote, VoiceID | 说话人识别和聚类 |
| **音频处理** | librosa, pydub | 音频分析和处理 |
| **深度学习框架** | PyTorch | 灵活的深度学习框架 |
| **GPU加速** | CUDA + cuDNN | GPU加速计算 |

### 5.5 开发环境与工具
| 技术类别 | 选择 | 用途 |
|---------|------|------|
| **编程语言** | Python 3.9+ | 主要开发语言 |
| **打包工具** | PyInstaller | 桌面应用打包 |
| **安装程序** | Inno Setup (Windows) | Windows安装程序制作 |
| **版本管理** | Git | 版本控制 |
| **代码质量** | Black, isort, flake8 | 代码格式化和质量检查 |
| **测试** | pytest, pytest-qt | 完整的测试框架 |
| **调试工具** | pdb, VS Code调试器 | 代码调试 |

### 5.6 硬件要求
- **CPU**：建议4核以上，支持AVX2指令集
- **GPU**：可选NVIDIA显卡，4GB以上显存（加速本地模型处理）
- **内存**：建议8GB以上
- **存储**：建议SSD，50GB以上可用空间
- **操作系统**：Windows 10/11, macOS 10.15+, Linux (Ubuntu 18.04+)

### 5.7 网络要求
- **带宽**：可选网络连接（用于在线API调用）
- **离线运行**：支持完全离线运行（使用本地模型）
- **API配额**：各服务API的调用配额管理（仅在线模式需要）

## 6. API集成限制和成本控制

### 6.1 API调用限制
**语音识别API限制：**
- **Azure Speech Services**：每月5000分钟免费，超出后$0.8/小时
- **Google Speech-to-Text**：每月60分钟免费，超出后$0.6/分钟
- **讯飞开放平台**：每日500次免费调用，超出后按次计费

**翻译API限制：**
- **DeepSeek R1**：每月100万字免费，超出后$0.002/千字
- **GLM-4.5**：每月50万字免费，超出后$0.003/千字
- **Google Translate**：每月50万字免费，超出后$20/百万字

**声音克隆API限制：**
- **MiniMax Audio**：每月1000次免费调用，超出后$0.05/次
- **其他TTS服务**：按字符数计费，$0.004/千字符

### 6.2 成本控制机制
**智能成本管理：**
- **预算设置**：用户可设置月度预算上限
- **实时监控**：显示当前月度使用量和费用
- **预警通知**：使用量达到80%时发出警告
- **自动切换**：达到限额时自动切换到免费方案

**本地优先策略：**
- **离线模式**：优先使用本地模型，避免API调用
- **混合处理**：关键部分使用API，常规部分使用本地模型
- **缓存复用**：最大化利用缓存，减少重复调用

**配额管理：**
- **服务选择**：根据剩余配额自动选择最优服务
- **负载均衡**：在多个服务间分配调用，避免单一服务超限
- **失败重试**：API失败时自动切换到备选方案

## 7. 风险评估

### 7.1 技术风险
- **模型准确性**：语音识别和翻译质量可能影响最终效果
- **性能瓶颈**：大文件处理可能遇到性能问题
- **兼容性**：不同视频格式的兼容性问题

### 7.2 业务风险
- **版权问题**：处理受版权保护的内容
- **数据隐私**：用户数据的隐私保护
- **服务成本**：在线API调用的成本控制

### 7.3 缓解措施
- **质量保证**：建立质量评估机制
- **性能优化**：优化算法和资源使用
- **合规管理**：确保符合相关法律法规
- **成本控制**：建立成本监控和预警机制